generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Client {
  id                            String                         @id
  name                          String
  doctorOrHospitalName          String
  location                      String
  services                      String[]
  accountManagerId              String?
  createdAt                     DateTime                       @default(now())
  type                          ClientType?                    @default(CLINIC)
  status                        ClientStatus                   @default(ONBOARDING)
  primaryContactName            String?
  phonePrimary                  String?
  phoneWhatsApp                 String?
  email                         String?
  addressLine                   String?
  area                          String?
  city                          String?
  pincode                       String?
  googleMapLink                 String?
  workingDays                   Json?
  workingTimings                String?
  startDate                     DateTime?
  endDate                       DateTime?
  monthlyAmount                 Float?
  planDuration                  InvoicePlanDuration?
  nextPaymentDate               DateTime?
  lastPaymentDate               DateTime?
  isGST                         Boolean                        @default(false)
  gstNumber                     String?
  gstRate                       Float?                         @default(18.0) // Default GST rate 18%
  discountPercent               Float?                         // Discount % applied to monthly amount (fallback when no line items)
  invoiceLineItems              Json?                          // [{ description, qty, rate, discountPercent? }] for item-wise invoice
  scopeFinalised                Boolean                        @default(false)
  onboardingCompletedAt         DateTime?
  preferredLanguage             PreferredLanguage?             @default(ENGLISH)
  User                          User?                          @relation(fields: [accountManagerId], references: [id])
  Task                          Task[]
  client_accesses               client_accesses[]
  client_approval_settings      client_approval_settings?
  client_assets                 client_assets[]
  client_branding               client_branding?
  client_competitors            client_competitors[]
  client_doctors                client_doctors[]
  client_kpi_monthly            client_kpi_monthly[]
  client_marketing_requirements client_marketing_requirements?
  client_services               client_services[]
  client_targeting              client_targeting?
  client_tasks                  client_tasks[]
  client_usps                   client_usps[]
  monthlyProductions            MonthlyProduction[]
  clientVideoMonths             ClientVideoMonth[]
  brandName                     String?
  primaryWhatsAppGroupLink      String?

  @@index([accountManagerId])
  @@index([status])
  @@index([type])
  @@index([nextPaymentDate])
}

model MonthlyProduction {
  id                    String   @id @default(cuid())
  clientId              String
  monthKey              String
  targetCount           Int      @default(10)
  designedCount         Int      @default(0)
  approvedCount         Int      @default(0)
  scheduledCount        Int      @default(0)
  canvaFolderUrl        String?
  lastSharedAt          DateTime?
  approvalPendingSince  DateTime?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  Client                Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, monthKey])
  @@index([clientId])
  @@index([monthKey])
}

model ClientVideoMonth {
  id            String    @id @default(cuid())
  clientId      String
  monthKey      String    // e.g. "2026-01"
  rawCount      Int       @default(0)   // reels shot at location, copied to office
  editedCount   Int       @default(0)   // edited and ready
  postedCount   Int       @default(0)   // posted this month (target 4)
  lastShootDate DateTime? // last shoot day at this client
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  Client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, monthKey])
  @@index([clientId])
  @@index([monthKey])
}

model Task {
  id                           String        @id
  title                        String
  description                  String?
  priority                     TaskPriority  @default(Medium)
  status                       TaskStatus    @default(Pending)
  assignedById                 String
  assignedToId                 String?
  clientId                     String?
  taskType                     String?
  startDate                    DateTime?
  dueDate                      DateTime?
  timeSpent                    Float?        @default(0)
  rejectionFeedback            String?
  createdAt                    DateTime      @default(now())
  User_Task_assignedByIdToUser User          @relation("Task_assignedByIdToUser", fields: [assignedById], references: [id], onDelete: Cascade)
  User_Task_assignedToIdToUser User?         @relation("Task_assignedToIdToUser", fields: [assignedToId], references: [id])
  Client                       Client?       @relation(fields: [clientId], references: [id])
  chat_threads                 chat_threads?

  @@index([assignedToId])
  @@index([clientId])
  @@index([status])
  @@index([taskType])
}

model User {
  id                                      String          @id
  name                                    String
  email                                   String          @unique
  passwordHash                            String
  role                                    UserRole
  isActive                                Boolean         @default(true)
  createdAt                               DateTime        @default(now())
  joiningDate                             DateTime?
  adminNotes                              String?
  jobTitle                                String?
  phoneNumber                             String?
  notifyChatMentions                      Boolean         @default(true)
  notifyClientChanges                     Boolean         @default(true)
  notifyTaskUpdates                       Boolean         @default(true)
  Client                                  Client[]
  Task_Task_assignedByIdToUser            Task[]          @relation("Task_assignedByIdToUser")
  Task_Task_assignedToIdToUser            Task[]          @relation("Task_assignedToIdToUser")
  activity_logs                           activity_logs[]
  attendances                             attendances[]
  chat_messages                           chat_messages[]
  chat_threads_chat_threads_user1IdToUser chat_threads[]  @relation("chat_threads_user1IdToUser")
  chat_threads_chat_threads_user2IdToUser chat_threads[]  @relation("chat_threads_user2IdToUser")
  chat_message_reads                      chat_message_reads[]
  client_assets                           client_assets[]
  client_tasks                            client_tasks[]
  subscription                            Subscription?
  chat_members                            ChatMember[]
  chat_messages_sent                      ChatMessage[]  @relation("ChatMessageSender")
  message_receipts                        MessageReceipt[]
  user_presence                           UserPresence?
  chat_notifications                      ChatNotification[]

  @@index([isActive])
  @@index([role])
}

model activity_logs {
  id         String   @id
  userId     String
  action     String
  entityType String
  entityId   String
  timestamp  DateTime @default(now())
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([userId])
}

model attendances {
  id                 String           @id
  userId             String
  loginTime          DateTime?
  logoutTime         DateTime?
  lunchStart         DateTime?
  lunchEnd           DateTime?
  totalHours         Float?
  date               DateTime         @db.Date
  status             AttendanceStatus @default(Present)
  mode               AttendanceMode   @default(OFFICE)
  earlySignInMinutes Int?
  lateSignInMinutes  Int?
  earlyLogoutMinutes Int?
  lateLogoutMinutes  Int?
  lastActivityTime   DateTime?
  wfhActivityPings   Int              @default(0)
  remark             String?
  editedBy           String?
  editedAt           DateTime?
  ipAddress          String?
  deviceInfo         String?
  location           String?
  User               User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@index([mode])
  @@index([userId])
}

model chat_messages {
  id           String       @id
  threadId     String
  senderId     String
  message      String
  isDeleted    Boolean      @default(false)
  createdAt    DateTime     @default(now())
  User         User         @relation(fields: [senderId], references: [id], onDelete: Cascade)
  chat_threads chat_threads @relation(fields: [threadId], references: [id], onDelete: Cascade)
  chat_message_reads chat_message_reads[]

  @@index([createdAt])
  @@index([senderId])
  @@index([threadId])
}

model chat_threads {
  id                              String               @id
  type                            ChatThreadType
  taskId                          String?              @unique
  user1Id                         String?
  user2Id                         String?
  createdAt                       DateTime             @default(now())
  chat_messages                   chat_messages[]
  Task                            Task?                @relation(fields: [taskId], references: [id], onDelete: Cascade)
  User_chat_threads_user1IdToUser User?                @relation("chat_threads_user1IdToUser", fields: [user1Id], references: [id], onDelete: Cascade)
  User_chat_threads_user2IdToUser User?                @relation("chat_threads_user2IdToUser", fields: [user2Id], references: [id], onDelete: Cascade)
  chat_unread_counts              chat_unread_counts[]

  @@unique([user1Id, user2Id])
  @@index([taskId])
  @@index([type])
}

model chat_unread_counts {
  id           String       @id
  threadId     String
  userId       String
  count        Int          @default(0)
  chat_threads chat_threads @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@index([userId])
}

model chat_message_reads {
  id        String   @id
  messageId String
  userId    String
  readAt    DateTime @default(now())
  chat_messages chat_messages @relation(fields: [messageId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@index([readAt])
}

model client_accesses {
  id                String           @id
  clientId          String
  type              ClientAccessType
  loginUrl          String?
  username          String?
  passwordEncrypted String?
  notes             String?
  createdAt         DateTime         @default(now())
  Client            Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([type])
}

model client_approval_settings {
  id                      String                   @id
  clientId                String                   @unique
  pointOfContactName      String?
  approvalTimeHours       Int?
  approvalMode            ApprovalMode?
  performanceTrackingMode PerformanceTrackingMode? @default(MANUAL)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime
  Client                  Client                   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model client_assets {
  id           String               @id
  clientId     String
  type         ClientAssetType
  category     ClientAssetCategory?
  title        String
  url          String
  mimeType     String?
  size         Int?
  uploadedById String
  createdAt    DateTime             @default(now())
  Client       Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  User         User                 @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([clientId])
  @@index([type])
}

model client_branding {
  id                  String   @id
  clientId            String   @unique
  brandColors         Json?
  designerName        String?
  templateBaseCreated Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  Client              Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model client_competitors {
  id            String   @id
  clientId      String
  name          String
  googleMapLink String?
  createdAt     DateTime @default(now())
  Client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model client_doctors {
  id                 String   @id
  clientId           String
  fullName           String
  qualification      String?
  specialization     String?
  experienceYears    Int?
  registrationNumber String?
  languagesSpoken    Json?
  photoAssetId       String?
  createdAt          DateTime @default(now())
  Client             Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model client_kpi_monthly {
  id                String       @id
  clientId          String
  month             String
  gmbCalls          Int          @default(0)
  directionRequests Int          @default(0)
  websiteClicks     Int          @default(0)
  leadsGenerated    Int          @default(0)
  reportStatus      ReportStatus @default(PENDING)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime
  Client            Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, month])
  @@index([clientId])
  @@index([month])
}

model client_marketing_requirements {
  id                  String   @id
  clientId            String   @unique
  gmbOptimisation     Boolean  @default(false)
  websiteSeo          Boolean  @default(false)
  socialPostsPerWeek  Int      @default(0)
  socialPostsPerMonth Int      @default(0)
  reelsPerMonth       Int      @default(0)
  googleAds           Boolean  @default(false)
  metaAds             Boolean  @default(false)
  reviewManagement    Boolean  @default(false)
  posters             Boolean  @default(false)
  videos              Boolean  @default(false)
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  Client              Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model client_services {
  id           String   @id
  clientId     String
  name         String
  isPriority   Boolean  @default(false)
  priorityRank Int?
  createdAt    DateTime @default(now())
  Client       Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model client_targeting {
  id              String   @id
  clientId        String   @unique
  primaryLocation String?
  nearbyAreas     Json?
  mainKeywords    Json?
  exampleKeywords Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  Client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
}

model client_tasks {
  id                  String     @id
  clientId            String
  month               String
  title               String
  status              TaskStatus @default(Pending)
  assignedToId        String?
  dueDate             DateTime?
  checklist           Json?
  createdFromTemplate Boolean    @default(false)
  createdAt           DateTime   @default(now())
  updatedAt           DateTime
  User                User?      @relation(fields: [assignedToId], references: [id])
  Client              Client     @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([assignedToId])
  @@index([clientId])
  @@index([month])
  @@index([status])
}

model client_usps {
  id        String   @id
  clientId  String
  uspText   String
  createdAt DateTime @default(now())
  Client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
}

model task_template_items {
  id             String         @id
  templateId     String
  title          String
  description    String?
  priority       TaskPriority   @default(Medium)
  dueDateOffset  Int?
  checklist      Json?
  order          Int            @default(0)
  createdAt      DateTime       @default(now())
  task_templates task_templates @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([order])
  @@index([templateId])
}

model task_templates {
  id                  String                @id
  name                String                @default("Monthly Fixed Template")
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  task_template_items task_template_items[]
}

model TaskTemplate {
  id            String   @id
  taskType      String   @unique
  durationHours Float
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([taskType])
  @@index([isActive])
}

enum ApprovalMode {
  WHATSAPP
  EMAIL
  BOTH
}

enum AttendanceMode {
  OFFICE
  WFH
  LEAVE
}

enum AttendanceStatus {
  Present
  Late
  HalfDay
  Absent
}

enum ChatThreadType {
  TASK
  DIRECT
  TEAM
}

enum ClientAccessType {
  GMB
  WEBSITE
  FACEBOOK
  INSTAGRAM
  WHATSAPP
}

enum ClientAssetCategory {
  RECEPTION
  CONSULTATION
  OT_LAB_PHARMACY
  EQUIPMENT
  OTHER
}

enum ClientAssetType {
  LOGO
  PHOTO
  VIDEO
  TEMPLATE
  DOCUMENT
}

enum ClientStatus {
  ONBOARDING
  ACTIVE
  PAUSED
}

enum ClientType {
  CLINIC
  HOSPITAL
  DOCTOR
}

enum PerformanceTrackingMode {
  AUTO
  MANUAL
}

enum PreferredLanguage {
  TELUGU
  ENGLISH
  BOTH
}

enum ReportStatus {
  PENDING
  IN_PROGRESS
  DONE
}

enum TaskPriority {
  Low
  Medium
  High
  Urgent
}

enum TaskStatus {
  Pending
  InProgress
  Review
  Approved
  Rejected
}

enum UserRole {
  SUPER_ADMIN
  MANAGER
  EMPLOYEE
}

enum InvoicePlanDuration {
  ONE_MONTH
  THREE_MONTHS
  SIX_MONTHS
}

model SubscriptionPlan {
  id                String         @id @default(cuid())
  name              String
  description       String?
  price             Float
  currency          String         @default("USD")
  interval          SubscriptionInterval
  stripePriceId     String?        @unique
  stripeProductId   String?
  features          Json?          // Array of feature strings
  maxClients        Int?           // null = unlimited
  maxUsers          Int?           // null = unlimited
  maxStorageGB      Int?           // null = unlimited
  isActive          Boolean        @default(true)
  isPopular         Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  subscriptions     Subscription[]

  @@index([isActive])
  @@index([interval])
}

model Subscription {
  id                    String             @id @default(cuid())
  userId                String             @unique
  planId                String
  status                SubscriptionStatus @default(ACTIVE)
  stripeSubscriptionId  String?           @unique
  stripeCustomerId      String?           @unique
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean           @default(false)
  canceledAt            DateTime?
  trialEndsAt           DateTime?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  User                  User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  SubscriptionPlan      SubscriptionPlan   @relation(fields: [planId], references: [id])

  @@index([status])
  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

enum SubscriptionInterval {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
  TRIALING
  INCOMPLETE
  INCOMPLETE_EXPIRED
}

model OfficeExpense {
  id        String   @id @default(cuid())
  name      String   // e.g., "Rent", "Maid", "Power Bill"
  amount    Float    // monthly amount in â‚¹
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
}

// ---- Realtime Team Chat (production-ready) ----
enum ChatRoomType {
  TEAM
  DIRECT
}

enum MessageReceiptStatus {
  SENT
  DELIVERED
  READ
}

model ChatRoom {
  id        String       @id @default(cuid())
  type      ChatRoomType
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  members   ChatMember[]
  messages  ChatMessage[]
  notifications ChatNotification[]

  @@index([type])
}

model ChatMember {
  id         String    @id @default(cuid())
  roomId     String
  userId     String
  lastReadAt DateTime?
  joinedAt   DateTime  @default(now())
  room       ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@index([roomId])
  @@index([userId])
}

model ChatMessage {
  id          String    @id @default(cuid())
  roomId      String
  senderId    String
  text        String
  clientMsgId String?   // for idempotency: upsert by (roomId, clientMsgId)
  createdAt   DateTime  @default(now())
  room        ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender      User      @relation("ChatMessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  receipts    MessageReceipt[]

  @@unique([roomId, clientMsgId])
  @@index([roomId, createdAt])
  @@index([senderId])
}

model MessageReceipt {
  id        String              @id @default(cuid())
  messageId String
  userId    String
  status    MessageReceiptStatus @default(SENT)
  createdAt DateTime            @default(now())
  message   ChatMessage         @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
}

model UserPresence {
  id        String   @id @default(cuid())
  userId    String   @unique
  lastSeenAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([lastSeenAt])
}

model ChatNotification {
  id        String    @id @default(cuid())
  userId    String
  roomId    String?
  messageId String?
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  room      ChatRoom? @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([roomId])
  @@index([readAt])
}
